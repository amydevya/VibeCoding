# Phase 4 端到端验证清单

## 前置条件

- 后端：`cd backend && python -m uvicorn app.main:app --reload`（端口 8000）
- 前端：`cd frontend && npm run dev`（端口 5173）
- 环境变量：后端 `.env` 中配置 `DASHSCOPE_API_KEY`；前端可选 `VITE_API_URL=http://localhost:8000`
- **网络**：若本地有代理，请确认代理可访问阿里云，或在后端启动前设置 `NO_PROXY=dashscope.aliyuncs.com` / 取消 HTTP_PROXY（后端已加 `trust_env=False` 绕过代理，但部分环境仍可能受影响）。

## 已知修复记录

| 问题 | 修复 | 文件 |
|------|------|------|
| CORS 500 响应不带 CORS 头 | 全局异常处理 + 中间件兜底 | `backend/app/main.py` |
| session_store.get_session 参数缺失 | 删除无参数 execute_query 调用 | `backend/app/db/session_store.py` |
| httpx 走代理 403 | `trust_env=False` 禁用系统代理 | `backend/app/core/llm.py` |
| 新建会话按钮传事件导致循环引用 | onClick 改为无参调用 | `frontend/src/components/Sidebar/NewSessionBtn.tsx` |

## 完整流程验证

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 打开 http://localhost:5173 | 三栏布局：左侧会话、中间问答、右侧图表 |
| 2 | 点击「新建会话」 | 左侧出现新会话，并自动选中 |
| 3 | 在输入框输入「查询销售表有多少条记录」并发送 | 中间出现用户消息；随后出现 SQL 预览、助手回复；右侧出现数据表格/图表 |
| 4 | 切换图表类型（柱状图/折线图/饼图等） | 右侧图表随类型切换 |
| 5 | 点击左侧另一会话（或新建再切回） | 中间加载该会话历史消息 |
| 6 | 删除某一会话 | 该会话从列表消失；若为当前会话则清空中间内容 |
| 7 | 不选会话直接发送消息 | 出现错误提示「请先选择或创建会话」 |

## 异常处理验证

| 场景 | 操作 | 预期 |
|------|------|------|
| 后端未启动 | 前端发送查询 | 显示网络/请求错误提示，可关闭 |
| 无效会话 ID | 通过接口传入不存在的 session_id | 后端返回 404，前端显示错误信息 |
| 空问题 | 发送空白或仅空格 | 不发送请求，无变化 |

## 数据流验证

- **会话持久化**：刷新页面后重新进入，会话列表与历史消息仍存在（依赖后端存储）。
- **流式响应**：发送查询后，先出现 SQL 预览，再出现数据/图表，最后出现完整回答（顺序可能因后端实现略有差异）。

## 性能与体验

- 新建会话、加载历史应在 2 秒内完成（依赖网络与后端）。
- 流式回答应逐字或逐段出现，无明显长时间卡顿。